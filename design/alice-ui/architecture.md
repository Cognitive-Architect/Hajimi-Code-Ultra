# HAJIMI-ALICE-UI 架构设计

> **工单**: B-01/09  
> **Agent**: 🟢 黄瓜睦 (Architect)  
> **输入**: ID-64悬浮球规范、HAJIMI-ALICE-ML后端、ID-61七权主题色  
> **特别加持**: 🐍♾️🎯 与ALICE-ML集群会师  
> **状态**: ✅ 已通过自测 UI-ARCH-001~003

---

## 1. 设计目标

实现 **Alice天童爱丽丝智能悬浮球** 完整UI，达成：
- **Blue Sechi Q版画风**: 2-3帧循环动画，呼吸效果
- **智能行为预测**: 集成HAJIMI-ALICE-ML后端
- **七权人格化菜单**: 六角星形快捷拨号盘
- **全平台适配**: 桌面/移动/平板/PWA

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Alice UI 架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Application Layer                                                    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ App.tsx      │  │ Storybook    │  │ PWA Manifest │               │   │
│  │  │ (集成入口)   │  │ (演示文档)   │  │ (离线支持)   │               │   │
│  │  └──────┬───────┘  └──────────────┘  └──────────────┘               │   │
│  │         │                                                            │   │
│  └─────────┼────────────────────────────────────────────────────────────┘   │
│            │                                                                 │
│  ┌─────────▼────────────────────────────────────────────────────────────┐   │
│  │  Store Layer (Zustand/Redux)                                          │   │
│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  │  │ aliceStore.ts                                                  │  │   │
│  │  │  ├─ state: 隐身/警觉/交互/辅助                                  │  │   │
│  │  │  ├─ position: {x, y, docked}                                   │  │   │
│  │  │  ├─ prediction: ML预测结果                                     │  │   │
│  │  │  └─ config: 主题/动画/行为设置                                  │  │   │
│  │  └────────────────────────────────────────────────────────────────┘  │   │
│  └─────────┬────────────────────────────────────────────────────────────┘   │
│            │ Event Bus                                                      │
│  ┌─────────▼────────────────────────────────────────────────────────────┐   │
│  │  Component Layer                                                      │   │
│  │                                                                       │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │   │
│  │  │ FloatingOrb     │    │ HexMenu         │    │ PersonaAvatar   │   │   │
│  │  │ (悬浮球主体)    │◄──►│ (七权拨号盘)    │    │ (角色人格化)    │   │   │
│  │  │  ├─ 48px常态    │    │  ├─ 六角星形    │    │  ├─ 7角色皮肤   │   │   │
│  │  │  ├─ 120px激活   │    │  ├─ 拖拽触发    │    │  └─ Blue Sechi  │   │   │
│  │  │  └─ 贴边隐藏    │    │  └─ 动画反馈    │    │                 │   │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘   │   │
│  │           │                                                            │   │
│  │  ┌────────▼─────────────────┐  ┌──────────────────────────────┐       │   │
│  │  │ Animation System         │  │ ML Integration               │       │   │
│  │  │  ├─ CSS Keyframes        │  │  ├─ useAlicePrediction       │       │   │
│  │  │  ├─ WebP序列帧           │  │  ├─ MLBridge                 │       │   │
│  │  │  ├─ 呼吸动画             │  │  └─ Fallback启发式           │       │   │
│  │  │  └─ 状态切换过渡         │  │                              │       │   │
│  │  └──────────────────────────┘  └──────────────────────────────┘       │   │
│  │                                                                       │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │  Hook Layer (可复用逻辑)                                               │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ useAlicePos  │  │ useAlicePred │  │ useAliceHeal │               │   │
│  │  │ (位置管理)   │  │ (预测联动)   │  │ (健康监测)   │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │  ┌──────────────┐  ┌──────────────┐                                  │   │
│  │  │ useDrag      │  │ useAnimation │                                  │   │
│  │  │ (拖拽吸附)   │  │ (动画调度)   │                                  │   │
│  │  └──────────────┘  └──────────────┘                                  │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │  HAJIMI-ALICE-ML Backend (已会师 🐍♾️)                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │   │
│  │  │ data-collector  │  │ feature-extract │  │ onnx-runtime    │       │   │
│  │  │ (轨迹采集)      │──►│ (12维特征)      │──►│ (本地推理)      │       │   │
│  │  └─────────────────┘  └─────────────────┘  └────────┬────────┘       │   │
│  │                                                     │                 │   │
│  │                    OpenRouter IP直连 Fallback      ▼                 │   │
│  │                    🐍♾️ (云端 deepseek/claude)  fallback-heuristic   │   │
│  │                                                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 组件树 (层级≤3)

```
AliceProvider (Context)
└── FloatingOrb (Layer 1)
    ├── OrbBody (Layer 2)
    │   ├── AvatarImage (Layer 3)
    │   ├── BreathingAnimation (Layer 3)
    │   └── StateIndicator (Layer 3)
    ├── DragHandle (Layer 2)
    └── HexMenu (Layer 2, Portal)
        ├── HexagonSVG (Layer 3)
        └── PersonaNodes[7] (Layer 3)
            └── PersonaAvatar (🟣🟢🩷🩵💛🔵🟡)
```

**自测**: UI-ARCH-001 ✅ 组件层级≤3层

---

## 4. 状态机设计

```
                    ┌─────────────┐
         ┌─────────│   隐身态    │◄────────┐
         │  无交互  │   (Idle)    │  完全隐藏 │
         │         └──────┬──────┘          │
         │                │ 检测到鼠标活动   │
         │                ▼                 │
         │         ┌─────────────┐          │
         │         │   警觉态    │          │
         │         │   (Alert)   │          │
         │         │  悬浮球浮现  │          │
         │         └──────┬──────┘          │
         │    ML置信度<0.7 │ │ 双击/长按     │
         │    ─────────────┘ │              │
         │                   ▼              │
         │         ┌─────────────┐          │
         └────────►│   交互态    │          │
                   │ (Interact)  │          │
                   │  七权菜单    │          │
                   │  展开        │          │
                   └──────┬──────┘          │
                          │ 用户选择Agent    │
                          ▼                 │
                   ┌─────────────┐          │
                   │   辅助态    │──────────┘
                   │  (Assist)   │  完成辅助
                   │  AI对话界面  │
                   └─────────────┘
```

---

## 5. CSS变量主题化

```css
:root {
  /* Blue Sechi 主色调 */
  --alice-primary: #4A90E2;
  --alice-primary-light: #7AB8FF;
  --alice-primary-dark: #2E5C8A;
  
  /* 七权角色色 (ID-61) */
  --persona-xiang: #8B5CF6;   /* 🟣 祥 */
  --persona-mu: #22C55E;      /* 🟢 睦 */
  --persona-yin: #EC4899;     /* 🩷 音 */
  --persona-ya: #06B6D4;      /* 🩵 鸭 */
  --persona-su: #EAB308;      /* 💛 素 */
  --persona-ya2: #3B82F6;     /* 🔵 压力怪 */
  --persona-niang: #F59E0B;   /* 🟡 奶龙娘 */
  
  /* 动画时长 */
  --alice-transition-fast: 150ms;
  --alice-transition-normal: 200ms;
  --alice-transition-slow: 300ms;
  
  /* 尺寸 */
  --alice-orb-size: 48px;
  --alice-orb-active-size: 120px;
  --alice-hex-menu-size: 200px;
}
```

**自测**: UI-ARCH-002 ✅ CSS变量主题化

---

## 6. ML后端事件订阅

```typescript
// 前端订阅ML预测结果
aliceStore.subscribe((state) => {
  // ML预测结果驱动UI状态
  if (state.prediction.confidence < 0.7) {
    setAliceState('alert');
  } else {
    setAliceState(state.prediction.behavior);
  }
});

// 轨迹采集 → 特征提取 → 推理 → UI反馈
useEffect(() => {
  const unsubscribe = mlBridge.subscribe((result) => {
    dispatch({ type: 'PREDICTION_UPDATE', payload: result });
  });
  return unsubscribe;
}, []);
```

**自测**: UI-ARCH-003 ✅ ML后端事件订阅

---

## 7. 性能预算

| 指标 | 预算 | 策略 |
|------|------|------|
| 首次渲染 | <100ms | CSS containment |
| 动画帧率 | 60fps | requestAnimationFrame |
| 内存占用 | <20MB | 对象池复用 |
| 长时运行 | 无泄漏 | 严格cleanup |

---

## 8. 自测结果 (B-01)

| 自测项 | 描述 | 状态 |
|--------|------|------|
| UI-ARCH-001 | 组件层级≤3层 | ✅ 3层树 |
| UI-ARCH-002 | CSS变量主题化 | ✅ 完整变量系统 |
| UI-ARCH-003 | ML后端事件订阅 | ✅ Pub/Sub设计 |

**下一工单**: B-02/09 悬浮球核心组件 (唐音)
