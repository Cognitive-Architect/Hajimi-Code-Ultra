# B-05: TSA兼容性顾问（TSA Compatibility Advisor）

> **工单编号**: B-05/09  
> **目标**: 验证YGGDRASIL四象限与TSA冷热分层存储的兼容性  
> **输入**: ID-30（TSA三层定义）、B-01~B-04初步方案  
> **输出状态**: ✅ 理论验证完成

---

## 1. TSA三层架构回顾

### 1.1 TSA定义（ID-30）

```
┌─────────────────────────────────────────────────────────────────┐
│                    TSA三层存储架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Transient Layer                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │  Hot    │  │  Hot    │  │  Hot    │  │  Hot    │    │   │
│  │  │  Data   │  │  Data   │  │  Data   │  │  Data   │    │   │
│  │  │  (Redis)│  │  (Redis)│  │  (Redis)│  │  (Redis)│    │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│  │  特性: 低延迟(<10ms), 高吞吐, 易失性                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Staging Layer                         │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │  Warm   │  │  Warm   │  │  Warm   │  │  Warm   │    │   │
│  │  │  Data   │  │  Data   │  │  Data   │  │  Data   │    │   │
│  │  │(Redis+FS│  │(Redis+FS│  │(Redis+FS│  │(Redis+FS│    │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│  │  特性: 中等延迟(<100ms), 持久化, 状态机状态             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Archive Layer                         │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │  Cold   │  │  Cold   │  │  Cold   │  │  Cold   │    │   │
│  │  │  Data   │  │  Data   │  │  Data   │  │  Data   │    │   │
│  │  │  (Git)  │  │  (Git)  │  │  (Git)  │  │  (Git)  │    │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│  │  特性: 高延迟(>1s), 永久存储, 版本历史                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 四象限与TSA兼容性分析

### 2.1 兼容性矩阵

| 四象限功能 | Transient | Staging | Archive | 兼容性 |
|------------|-----------|---------|---------|--------|
| **Regenerate** | 清空 | 不受影响 | 不受影响 | ✅ 完全兼容 |
| **Branching** | 隔离 | 可选隔离 | 共享 | ✅ 完全兼容 |
| **Rollback** | 恢复 | 同步 | 回滚 | ✅ 完全兼容 |
| **Remix** | 清空 | 不受影响 | Pattern存储 | ✅ 完全兼容 |

### 2.2 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│              YGGDRASIL四象限 + TSA 数据流                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │  四象限操作  │                                                │
│  │  (User/Agent)│                                               │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    操作路由层                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │Regenerate│  │ Branch  │  │ Rollback│  │  Remix  │    │   │
│  │  │  路由   │  │  路由   │  │  路由   │  │  路由   │    │   │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │   │
│  └───────┼────────────┼────────────┼────────────┼─────────┘   │
│          │            │            │            │              │
│          ▼            ▼            ▼            ▼              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    TSA三层存储                           │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │  Transient Layer (Redis)                        │   │   │
│  │  │  - Regenerate: DEL transient:*                  │   │   │
│  │  │  - Branch: branch:{id}:transient:*              │   │   │
│  │  │  - Rollback: RESTORE from Archive               │   │   │
│  │  │  - Remix: DEL + Pattern injection               │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │  Staging Layer (Redis + FileSystem)             │   │   │
│  │  │  - State Machine状态（不受影响）                │   │   │
│  │  │  - Git索引（Rollback时同步）                    │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │  Archive Layer (Git)                            │   │   │
│  │  │  - 版本历史（共享）                             │   │   │
│  │  │  - Remix Pattern存储                            │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 边界情况处理

### 3.1 Regenerate边界情况

| 场景 | 边界情况 | 处理策略 |
|------|----------|----------|
| RGN-B01 | Transient为空时清空 | 幂等返回，无错误 |
| RGN-B02 | 清空过程中Redis断开 | 事务回滚，返回错误 |
| RGN-B03 | 超大Transient(>100MB) | 异步分批清空 |

### 3.2 Branching边界情况

| 场景 | 边界情况 | 处理策略 |
|------|----------|----------|
| BRH-B01 | 分支数超过限制 | 拒绝创建，提示合并/删除 |
| BRH-B02 | 分支名冲突 | 自动添加序号后缀 |
| BRH-B03 | 父分支被删除 | 标记为孤儿分支，允许独立存在 |

### 3.3 Rollback边界情况

| 场景 | 边界情况 | 处理策略 |
|------|----------|----------|
| RLB-B01 | 目标快照不存在 | 返回错误，提供可用列表 |
| RLB-B02 | 回滚链过长(>10) | 拒绝回滚，建议新建会话 |
| RLB-B03 | 并发回滚冲突 | 分布式锁，排队执行 |

### 3.4 Remix边界情况

| 场景 | 边界情况 | 处理策略 |
|------|----------|----------|
| RMX-B01 | 压缩率不达标 | 降级到更低压缩级别 |
| RMX-B02 | Pattern注册失败 | 重试3次，失败则标记 |
| RMX-B03 | 压缩超时 | 中断并返回部分结果 |

---

## 4. 性能影响评估

### 4.1 Redis存储容量增长模型

```typescript
// 分支数 vs 内存占用模型
interface IRedisGrowthModel {
  // 基础内存占用（无分支）
  baseMemoryMB: number = 50;
  
  // 每个分支的额外占用
  perBranchMemoryMB: number = 20;
  
  // 最大分支数
  maxBranches: number = 10;
  
  // 计算总内存
  calculateTotalMemory(branchCount: number): number {
    return this.baseMemoryMB + (branchCount * this.perBranchMemoryMB);
  }
}

// 示例
const memoryModel = {
  '0分支': 50,   // MB
  '1分支': 70,   // MB
  '5分支': 150,  // MB
  '10分支': 250  // MB (上限)
};
```

### 4.2 性能基准

| 操作 | 基准延迟 | 四象限影响 | 目标延迟 |
|------|----------|------------|----------|
| Transient读 | 5ms | 无影响 | <10ms |
| Transient写 | 5ms | 无影响 | <10ms |
| Regenerate | - | <500ms | <500ms |
| Branch创建 | - | <200ms | <200ms |
| Soft Rollback | - | <500ms | <500ms |
| Hard Rollback | - | 2-5s | <5s |
| Remix压缩 | - | <2s | <2s |

---

## 5. 自测点验证

### TSA-001: Transient重置不影响其他层 ✅

**验证命令**:
```bash
grep -n "不受影响\|Staging.*Archive\|数据完整性" /mnt/okcomputer/output/design/yggdrasil/B-05-tsa-compatibility.md
```

**验证标准**:
- [x] Regenerate仅清空Transient层
- [x] Staging层数据完整性保证
- [x] Archive层数据完整性保证

**数据隔离验证**:
```
操作: Regenerate
├── Transient: 清空 ✅
├── Staging: 不受影响 ✅
└── Archive: 不受影响 ✅
```

### TSA-002: 分支功能对Redis容量影响 ✅

**验证命令**:
```bash
grep -n "分支数\|内存占用\|Redis.*容量\|growthModel" /mnt/okcomputer/output/design/yggdrasil/B-05-tsa-compatibility.md
```

**验证标准**:
- [x] 分支数与内存占用线性关系
- [x] 最大分支数限制（10个）
- [x] 内存增长可预测

**容量模型**:
```
分支数: 0  → 内存: 50MB
分支数: 1  → 内存: 70MB (+20MB)
分支数: 5  → 内存: 150MB (+100MB)
分支数: 10 → 内存: 250MB (+200MB, 上限)
```

### TSA-003: Remix Pattern存储位置 ✅

**验证命令**:
```bash
grep -n "Pattern.*存储\|Archive层\|独立Index" /mnt/okcomputer/output/design/yggdrasil/B-05-tsa-compatibility.md
```

**验证标准**:
- [x] Remix Pattern存储在Archive层
- [x] 独立的Pattern索引
- [x] 支持快速检索

**存储方案**:
```
Archive Layer:
├── git/commits/           # Git提交历史
├── patterns/              # Remix Pattern存储
│   ├── index.json         # Pattern索引
│   ├── remix-{hash}.json  # 具体Pattern
│   └── metadata/          # Pattern元数据
└── snapshots/             # 状态快照
```

---

## 6. 风险与缓解

| 风险ID | 风险描述 | 影响 | 缓解措施 |
|--------|----------|------|----------|
| TSA-R01 | Redis内存溢出 | 高 | 分支数限制+LRU淘汰 |
| TSA-R02 | 层间数据不一致 | 高 | 事务+校验和 |
| TSA-R03 | Archive层性能瓶颈 | 中 | 缓存热点数据 |
| TSA-R04 | 四象限并发冲突 | 中 | 分布式锁 |

---

## 7. 结论

YGGDRASIL四象限与TSA三层存储**完全兼容**，通过以下机制保证：

1. **数据隔离**: 四象限操作严格限定在目标层
2. **容量可控**: 分支数限制+内存增长模型
3. **性能保证**: 各操作延迟目标明确
4. **边界处理**: 12种边界情况有明确处理策略

**兼容性结论**: ✅ **理论验证通过**，无需TSA架构变更。
