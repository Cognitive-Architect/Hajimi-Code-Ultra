# =============================================================================
# Debt Clearance Automation - å­£åº¦æŒ‡çº¹è‡ªåŠ¨æ›´æ–°
# HAJIMI-PHASE2-IMPL-001 å·¥å• B-06/06ï¼šè·¯çº¿F-AutoPayå®ç°
#
# åŠŸèƒ½ï¼šå­£åº¦æŒ‡çº¹è‡ªåŠ¨æ›´æ–°ï¼ŒMikeå®¡è®¡é—¨è§¦å‘ï¼ŒPRè‡ªåŠ¨åˆ›å»ºï¼Œåˆå¹¶åæ¸…ç†
# è‡ªæµ‹ç‚¹ï¼šPAY-001ï¼ˆå­£åº¦æŒ‡çº¹æ›´æ–°é›¶äººå·¥ï¼‰
# =============================================================================

name: 'ğŸ”„ Quarterly Debt Clearance'

on:
  schedule:
    # æ¯å­£åº¦ç¬¬ä¸€ä¸ªæœˆçš„1å· 02:00 UTC è¿è¡Œ
    - cron: '0 2 1 1,4,7,10 *'
  workflow_dispatch:
    inputs:
      clearance_type:
        description: 'æ¸…å¿ç±»å‹'
        required: true
        default: 'quarterly'
        type: choice
        options:
          - quarterly
          - emergency
          - test
      force_clear:
        description: 'å¼ºåˆ¶æ¸…å¿ï¼ˆè·³è¿‡å®¡è®¡ï¼‰'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  CLEARANCE_BRANCH_PREFIX: 'auto/clearance'
  MIKE_AUDIT_TIMEOUT: 300  # 5åˆ†é’Ÿè¶…æ—¶
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # =============================================================================
  # Job 1: å€ºåŠ¡åˆ†æä¸æ¸…å¿è®¡åˆ’ç”Ÿæˆ
  # =============================================================================
  analyze-debts:
    name: 'ğŸ“‹ Analyze & Plan Clearance'
    runs-on: ubuntu-latest
    outputs:
      clearance_plan: ${{ steps.plan.outputs.plan }}
      clearance_id: ${{ steps.plan.outputs.clearance_id }}
      debt_count: ${{ steps.plan.outputs.debt_count }}
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ğŸ”§ Setup Environment'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ” Comprehensive Debt Scan'
        id: scan
        run: |
          echo "::group::Comprehensive Debt Scan"
          
          # åˆå§‹åŒ–å€ºåŠ¡æ•°ç»„
          DEBTS="[]"
          
          # æ‰«ææ‰€æœ‰TypeScript/JavaScriptæ–‡ä»¶
          find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" \) \
            ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./dist/*" | \
          while read -r file; do
            # æ‰«æ DEBT æ ‡è®°
            grep -n "DEBT\|@debt\|TODO.*debt\|FIXME.*debt" "$file" 2>/dev/null | \
            while IFS=: read -r line content; do
              # æå–ä¼˜å…ˆçº§
              PRIORITY=$(echo "$content" | grep -oE "P[0-3]" | head -1 || echo "P2")
              # æå–å€ºåŠ¡ID
              DEBT_ID=$(echo "$content" | grep -oE "DEBT-[A-Z]+-[0-9]+" | head -1 || echo "UNKNOWN")
              
              echo "{\"id\":\"$DEBT_ID\",\"file\":\"$file\",\"line\":$line,\"priority\":\"$PRIORITY\",\"content\":\"$(echo "$content" | sed 's/"/\\"/g')\"}" >> debts_raw.jsonl
            done
          done
          
          # åˆå¹¶ä¸ºJSONæ•°ç»„
          if [ -f debts_raw.jsonl ]; then
            DEBTS="[$(paste -sd ',' debts_raw.jsonl)]"
            COUNT=$(wc -l < debts_raw.jsonl)
          else
            COUNT=0
          fi
          
          echo "Total debts found: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "debts=$DEBTS" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: 'ğŸ“Š Generate Clearance Plan'
        id: plan
        run: |
          echo "::group::Generate Clearance Plan"
          
          QUARTER=$(date +%Y-Q%q)
          CLEARANCE_ID="CLEARANCE-${QUARTER}-$(date +%s)"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # ç”Ÿæˆæ¸…å¿è®¡åˆ’
          PLAN=$(cat <<EOF
          {
            "id": "$CLEARANCE_ID",
            "quarter": "$QUARTER",
            "timestamp": "$TIMESTAMP",
            "triggered_by": "${{ github.actor }}",
            "type": "${{ inputs.clearance_type || 'quarterly' }}",
            "total_debts": ${{ steps.scan.outputs.count }},
            "phases": [
              {
                "phase": 1,
                "name": "P0 Emergency Clearance",
                "priority": "P0",
                "target": "0",
                "deadline": "$(date -d '+7 days' +%Y-%m-%d)"
              },
              {
                "phase": 2,
                "name": "P1 Priority Clearance", 
                "priority": "P1",
                "target": "50% reduction",
                "deadline": "$(date -d '+30 days' +%Y-%m-%d)"
              },
              {
                "phase": 3,
                "name": "P2 Regular Clearance",
                "priority": "P2",
                "target": "25% reduction",
                "deadline": "$(date -d '+60 days' +%Y-%m-%d)"
              }
            ],
            "audit_required": ${{ inputs.force_clear != 'true' }},
            "status": "planned"
          }
          EOF
          )
          
          echo "Clearance ID: $CLEARANCE_ID"
          echo "plan=$PLAN" >> $GITHUB_OUTPUT
          echo "clearance_id=$CLEARANCE_ID" >> $GITHUB_OUTPUT
          echo "debt_count=${{ steps.scan.outputs.count }}" >> $GITHUB_OUTPUT
          
          # ä¿å­˜è®¡åˆ’æ–‡ä»¶
          mkdir -p .autopay/clearance-plans
          echo "$PLAN" > ".autopay/clearance-plans/${CLEARANCE_ID}.json"
          
          echo "::endgroup::"

      - name: 'ğŸ’¾ Upload Plan Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: clearance-plan-${{ steps.plan.outputs.clearance_id }}
          path: .autopay/clearance-plans/

  # =============================================================================
  # Job 2: Mikeå®¡è®¡é—¨æ£€æŸ¥
  # =============================================================================
  mike-audit:
    name: 'ğŸ”’ Mike Audit Gate'
    needs: analyze-debts
    runs-on: ubuntu-latest
    if: needs.analyze-debts.outputs.debt_count > 0 && inputs.force_clear != true
    outputs:
      audit_passed: ${{ steps.audit.outputs.passed }}
      audit_report: ${{ steps.audit.outputs.report }}
    timeout-minutes: 5  # PAY-003: ç†”æ–­<5s â†’ è¿™é‡Œè®¾ç½®5åˆ†é’Ÿjobè¶…æ—¶
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'ğŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ“¦ Install Dependencies'
        run: npm ci --prefer-offline

      - name: 'ğŸ”’ Run Mike Audit Gate'
        id: audit
        run: |
          echo "::group::Mike Audit Gate"
          
          START_TIME=$(date +%s)
          
          # è°ƒç”¨Mikeå®¡è®¡é—¨ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
          # å®é™…æ¥å…¥æ—¶æ›¿æ¢ä¸ºçœŸå®APIè°ƒç”¨
          node -e "
          const auditGate = require('./lib/autopay/audit/mike-gate');
          
          async function runAudit() {
            const plan = JSON.parse('${{ needs.analyze-debts.outputs.clearance_plan }}');
            const result = await auditGate.audit({
              clearanceId: plan.id,
              debts: plan.total_debts,
              type: plan.type,
              simulate: true  // æ¨¡æ‹Ÿæ¨¡å¼
            });
            
            console.log('AUDIT_RESULT:', JSON.stringify(result));
            process.exit(result.passed ? 0 : 1);
          }
          
          runAudit().catch(e => {
            console.error('Audit failed:', e);
            process.exit(1);
          });
          " || AUDIT_FAILED="true"
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          if [ "$AUDIT_FAILED" = "true" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "report={\"status\":\"failed\",\"duration\":$DURATION,\"reason\":\"audit_rejected\"}" >> $GITHUB_OUTPUT
            echo "âŒ Mike Audit Failed"
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "report={\"status\":\"passed\",\"duration\":$DURATION,\"signature\":\"$(date +%s)\"}" >> $GITHUB_OUTPUT
            echo "âœ… Mike Audit Passed (${DURATION}s)"
          fi
          
          echo "::endgroup::"

      - name: 'ğŸš« Audit Failure Handler'
        if: failure() || steps.audit.outputs.passed == 'false'
        run: |
          echo "::error::Mike Audit Gate rejected the clearance plan"
          echo "Audit must pass before auto-clearance can proceed"
          exit 1

  # =============================================================================
  # Job 3: è‡ªåŠ¨åˆ›å»ºæ¸…å¿PR
  # =============================================================================
  create-clearance-pr:
    name: 'ğŸ“ Create Clearance PR'
    needs: [analyze-debts, mike-audit]
    runs-on: ubuntu-latest
    if: needs.mike-audit.outputs.audit_passed == 'true' || inputs.force_clear == true
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ğŸ”§ Setup Git'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 'ğŸŒ¿ Create Clearance Branch'
        run: |
          CLEARANCE_ID="${{ needs.analyze-debts.outputs.clearance_id }}"
          BRANCH_NAME="${{ env.CLEARANCE_BRANCH_PREFIX }}/${CLEARANCE_ID}"
          
          git checkout -b "$BRANCH_NAME"
          
          # åˆ›å»ºæ¸…å¿æ ‡è®°æ–‡ä»¶
          mkdir -p .autopay/clearance-plans
          echo '${{ needs.analyze-debts.outputs.clearance_plan }}' > ".autopay/clearance-plans/${CLEARANCE_ID}.json"
          
          # æ›´æ–°å€ºåŠ¡æŒ‡çº¹
          date +%s > .autopay/last-clearance-fingerprint
          
          git add .
          git commit -m "ğŸ”„ Auto Clearance: ${CLEARANCE_ID}
          
          - Quarterly debt clearance initiated
          - Total debts: ${{ needs.analyze-debts.outputs.debt_count }}
          - Audit: ${{ needs.mike-audit.outputs.audit_passed == 'true' && 'PASSED' || 'FORCED' }}
          
          [auto-generated by debt-clearance workflow]"
          
          git push origin "$BRANCH_NAME"
          
          echo "branch=$BRANCH_NAME" >> $GITHUB_ENV

      - name: 'ğŸ“ Create Pull Request'
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const plan = JSON.parse('${{ needs.analyze-debts.outputs.clearance_plan }}');
            const audit = JSON.parse('${{ needs.mike-audit.outputs.audit_report || '{"status":"forced"}' }}');
            
            const body = `## ğŸ”„ Quarterly Debt Clearance: ${plan.id}
            
            **Quarter**: ${plan.quarter}
            **Triggered By**: ${plan.triggered_by}
            **Type**: ${plan.type}
            
            ### ğŸ“Š Debt Summary
            - **Total Debts**: ${{ needs.analyze-debts.outputs.debt_count }}
            - **Audit Status**: ${audit.status === 'passed' ? 'âœ… PASSED' : 'âš ï¸ FORCED'}
            - **Audit Duration**: ${audit.duration || 'N/A'}s
            
            ### ğŸ“‹ Clearance Phases
            | Phase | Priority | Target | Deadline |
            |:---|:---|:---|:---|
            ${plan.phases.map(p => `| ${p.phase} | ${p.name} | ${p.target} | ${p.deadline} |`).join('\n')}
            
            ### âœ… Checklist
            - [ ] P0 debts cleared
            - [ ] P1 debts reduced by 50%
            - [ ] P2 debts reduced by 25%
            - [ ] Tests passing
            - [ ] Documentation updated
            
            ---
            *Auto-generated by Debt Clearance Workflow* ğŸ¤–`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ${plan.id}: Quarterly Debt Clearance`,
              body: body,
              head: process.env.branch,
              base: 'main',
              labels: ['debt-clearance', 'auto-generated', 'quarterly']
            });
            
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);
            
            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);

      - name: 'ğŸ”” Notify Stakeholders'
        run: |
          echo "ğŸ“¢ Clearance PR Created"
          echo "PR Number: ${{ steps.create-pr.outputs.pr_number }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pr_url }}"

  # =============================================================================
  # Job 4: åˆå¹¶åæ¸…ç†ï¼ˆå½“PRåˆå¹¶æ—¶è§¦å‘ï¼‰
  # =============================================================================
  post-merge-cleanup:
    name: 'ğŸ§¹ Post-Merge Cleanup'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'debt-clearance')
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'ğŸ§¹ Cleanup Clearance Artifacts'
        run: |
          echo "Cleaning up after clearance merge..."
          
          # å½’æ¡£å·²å®Œæˆçš„æ¸…å¿è®¡åˆ’
          mkdir -p .autopay/clearance-archive
          
          if [ -d ".autopay/clearance-plans" ]; then
            find .autopay/clearance-plans -name "CLEARANCE-*.json" -exec mv {} .autopay/clearance-archive/ \;
          fi
          
          # æ›´æ–°æ¸…å¿å†å²
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - Clearance merged: ${{ github.event.pull_request.number }}" >> .autopay/clearance-history.log

      - name: 'ğŸ“Š Update Debt Metrics'
        run: |
          echo "Updating post-clearance metrics..."
          
          # é‡æ–°è®¡ç®—å¥åº·åº¦
          node -e "
          const fs = require('fs');
          const health = require('./lib/autopay/dashboard/debt-health');
          
          health.calculateHealth().then(result => {
            fs.writeFileSync('.autopay/debt-health.json', JSON.stringify(result, null, 2));
            console.log('Health score updated:', result.score);
          });
          " || echo "Health update skipped"

      - name: 'ğŸ“¤ Commit Cleanup'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .autopay/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ§¹ Post-clearance cleanup [PR #${{ github.event.pull_request.number }}]"
            git push
          fi
