# 风险与后续建议

> **文档版本**: v1.0.0  
> **关联工单**: HAJIMI-DEBT-CLEARANCE-001-LAZY-MVP  
> **最后更新**: 2026-02-17

---

## 1. 当前风险清单

### 1.1 高风险 🔴

#### R1: HNSW索引规模限制（单节点）

| 项目 | 描述 |
|------|------|
| **风险描述** | 当前Lazy-RAG使用单节点HNSW索引，性能测试显示超过10万向量时内存和延迟显著恶化 |
| **影响** | 无法支持大规模知识库（>10万文档） |
| **概率** | 高（业务增长必然触发） |
| **当前状态** | 10万向量时：冷启动15.5s，内存780MB，延迟245ms - 全部超标 |

```
规模测试结果:
1,000向量   ✅ 0.8s  / 62MB  / 35ms
5,000向量   ✅ 1.5s  / 118MB / 68ms
10,000向量  ✅ 2.46s / 174MB / 92ms
50,000向量  ⚠️ 8.2s  / 420MB / 156ms
100,000向量 ❌ 15.5s / 780MB / 245ms
```

**缓解措施**:
1. 当前：监控向量数量，超过阈值告警
2. 短期：实施数据归档策略，定期清理旧数据
3. 长期：考虑分片或云端方案（见建议S1）

---

### 1.2 中风险 🟡

#### R2: P95延迟余量不足

| 项目 | 描述 |
|------|------|
| **风险描述** | 当前P95延迟92.45ms，距离100ms阈值仅7.55%余量 |
| **影响** | 负载波动时可能触发降级 |
| **概率** | 中（并发增加时触发） |

**缓解措施**:
1. 调整HNSW参数：`efSearch`从64降至48
2. 启用查询缓存（高频查询）
3. 限制并发数（推荐≤10）

---

#### R3: 量化精度波动

| 项目 | 描述 |
|------|------|
| **风险描述** | 动态量化依赖输入分布，极端输入可能导致精度下降 |
| **影响** | 推理准确率临时下降 |
| **概率** | 中（边界情况） |

**缓解措施**:
1. 自动回退机制已实施（相似度<0.95时回退FP32）
2. 持续监控INT8/FP32推理比例
3. 定期更新校准数据

---

### 1.3 低风险 🟢

#### R4: 内存占用接近阈值

| 项目 | 描述 |
|------|------|
| **风险描述** | 10k向量内存174MB，距离200MB阈值仅13%余量 |
| **影响** | 系统其他组件内存不足 |
| **概率** | 低（当前环境32GB内存） |

**缓解措施**:
1. 启用内存映射模式（mmap）
2. 监控内存使用趋势
3. 设置内存上限告警

---

#### R5: 跨平台兼容性

| 项目 | 描述 |
|------|------|
| **风险描述** | HNSW索引文件在不同架构（x64/ARM）间可能不兼容 |
| **影响** | 需要为不同平台维护独立索引 |
| **概率** | 低（当前仅x64部署） |

**缓解措施**:
1. 文档明确平台限制
2. 考虑使用ONNX格式存储向量（跨平台）

---

## 2. 后续建议

### 2.1 短期建议（1-2周）

#### S1: 监控告警配置

**建议**: 配置关键指标监控

```yaml
# 监控项
alerts:
  - name: "HighP95Latency"
    condition: "p95_latency > 90ms"
    severity: warning
    
  - name: "MemoryLimitApproaching"
    condition: "memory_usage > 180MB"
    severity: warning
    
  - name: "VectorCountHigh"
    condition: "vector_count > 8000"
    severity: info
    
  - name: "FallbackRateHigh"
    condition: "fallback_rate > 5%"
    severity: critical
```

**优先级**: P0  
**工作量**: 4小时

---

#### S2: 查询缓存

**建议**: 为高频查询添加LRU缓存

```typescript
// 预期效果
// P95延迟: 92ms → 75ms
// 缓存命中率: ~30%（基于查询模式分析）
```

**优先级**: P1  
**工作量**: 8小时

---

### 2.2 中期建议（1-3月）

#### S3: Pinecone云迁移评估 ⭐

**建议**: 评估Pinecone等云向量数据库作为扩展方案

| 对比项 | 本地HNSW | Pinecone |
|--------|----------|----------|
| 规模上限 | 10万向量 | 无限 |
| 延迟 | <100ms | 50-150ms |
| 成本 | 0 | $0.10/1000 queries |
| 维护 | 高 | 低 |

**决策点**:
- 向量数量持续增长趋势
- 团队运维能力
- 预算审批

**优先级**: P1  
**工作量**: 调研2周 + 实施4周

---

#### S4: 增量索引更新

**建议**: 支持文档增删改时的增量索引更新

**当前限制**: MVP仅支持预计算向量，无法实时更新

**实现方案**:
```
文档变更 ──▶ 差异检测 ──▶ 增量HNSW更新 ──▶ 索引热重载
```

**优先级**: P2  
**工作量**: 2周

---

#### S5: 多节点分片

**建议**: 单节点达到上限时支持多节点分片

**分片策略**:
```
文档哈希 ──▶ 路由到对应分片 ──▶ 聚合结果
   │
   ├──▶ Shard 1 (0-33%)
   ├──▶ Shard 2 (33-66%)
   └──▶ Shard 3 (66-100%)
```

**优先级**: P2  
**工作量**: 4周

---

### 2.3 长期建议（3-6月）

#### S6: 知识图谱RAG增强

**建议**: 引入知识图谱增强检索质量

```
Query ──▶ 实体抽取 ──▶ 图谱查询 ──▶ 混合排序
              │
              └──▶ 向量检索 ───────┘
```

**预期提升**: 准确率 +5-10%

**优先级**: P3  
**工作量**: 8周

---

#### S7: 多模态检索

**建议**: 支持图片、代码等多模态内容检索

**场景**:
- 截图搜索相关文档
- 代码片段语义检索

**优先级**: P3  
**工作量**: 6周

---

#### S8: 边缘设备优化

**建议**: 优化ONNX模型支持边缘设备部署

**目标设备**:
- 移动设备（ARM）
- 嵌入式设备（树莓派等）

**优化方向**:
- 模型剪枝
- 算子融合
- INT4量化（极致压缩）

**优先级**: P3  
**工作量**: 6周

---

## 3. 技术债务跟踪

### 3.1 已清零债务 ✅

| 债务项 | 清零日期 | 验证方式 |
|--------|----------|----------|
| SecondMe依赖 | 2026-02-17 | 全局搜索0引用 |
| FP32推理性能 | 2026-02-17 | 性能预算达成 |
| 架构文档缺失 | 2026-02-17 | 六件套交付 |

### 3.2 新增债务 ⚠️

| 债务项 | 严重程度 | 计划解决 |
|--------|----------|----------|
| 单节点规模限制 | 高 | S3/S5（1-3月） |
| 无实时索引更新 | 中 | S4（1-3月） |
| 监控不完善 | 低 | S1（1-2周） |

---

## 4. 决策树

```
向量数量增长?
    │
    ├─ 否 ──▶ 保持现状，监控即可
    │
    └─ 是 ──▶ 增长速度?
                 │
                 ├─ 慢(<100/月) ──▶ 数据归档策略
                 │
                 └─ 快(>100/月) ──▶ 预算允许?
                                    │
                                    ├─ 否 ──▶ S5 多节点分片
                                    │
                                    └─ 是 ──▶ S3 Pinecone迁移
```

---

## 5. 附录

### 5.1 风险矩阵

```
影响
 高 │ 🔴 R1          │
    │                │
 中 │ 🟡 R2  R3      │
    │                │
 低 │ 🟢 R4  R5      │
    └────────────────┘
      低    中    高   概率
```

### 5.2 优先级定义

| 优先级 | 定义 | 响应时间 |
|--------|------|----------|
| P0 | 阻塞发布 | 立即 |
| P1 | 重要 | 1-2周 |
| P2 | 一般 | 1-3月 |
| P3 | 优化 | 3-6月 |

### 5.3 参考文档

- [性能预算验证报告](./性能预算验证报告.md)
- [架构决策记录](./ADR-Lazy-RAG.md)
- [Pinecone官方文档](https://docs.pinecone.io/)

---

**文档结束**

> 风险管理是一个持续过程。建议每月 review 本清单，根据实际情况调整优先级。
