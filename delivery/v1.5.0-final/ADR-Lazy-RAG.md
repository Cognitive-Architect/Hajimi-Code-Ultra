# 架构决策记录 (ADR) - Lazy-RAG

> **ADR编号**: ADR-001  
> **标题**: Lazy-RAG MVP架构决策  
> **日期**: 2026-02-17  
> **状态**: 已接受 ✅  
> **决策者**: Soyorin, 唐音

---

## 1. 背景

### 1.1 问题陈述

Hajimi Code Ultra项目存在两项关键技术债务：

1. **SecondMe依赖**: 原RAG层重度依赖SecondMe云服务，导致：
   - 离线环境无法使用
   - 数据隐私风险
   - 网络延迟不可控
   - 成本高昂

2. **FP32推理性能**: Alice ML引擎使用FP32模型，导致：
   - 模型体积大（200KB+）
   - 推理延迟高（25ms+）
   - 内存占用高（150MB+）

### 1.2 约束条件

| 约束 | 说明 |
|------|------|
| 时间 | 必须在2周内完成MVP |
| 资源 | 仅限现有团队，无新增人力 |
| 兼容性 | 必须兼容现有LCR接口 |
| 性能 | P95延迟<100ms，内存<200MB |

---

## 2. 决策

### 2.1 决策概述

我们决定：

1. **移除SecondMe，采用Lazy-RAG本地MVP**
2. **采用ONNX动态量化替代FP32**

### 2.2 决策详情

#### 决策1: 移除SecondMe，采用Lazy-RAG本地MVP

**决策内容**: 
- 全面移除SecondMe云服务依赖
- 构建本地Lazy-RAG MVP，仅保留核心查询功能
- 使用HNSW本地索引替代云端向量检索

**动机**:
| 因素 | SecondMe方案 | Lazy-RAG MVP方案 |
|------|--------------|------------------|
| 网络依赖 | 必需 | 完全离线可用 |
| 数据隐私 | 数据上云 | 本地处理 |
| 延迟 | 100-500ms | <100ms |
| 成本 | 按调用付费 | 一次性开发 |
| 可控性 | 受限于服务商 | 完全可控 |

**权衡**:
- ✅ 获得：离线可用、低延迟、零成本、高隐私
- ❌ 牺牲：功能简化、无实时更新、单节点限制

**影响范围**:
- 删除所有SecondMe引用（全局清理）
- 简化API至仅保留POST /query
- 新增本地HNSW索引管理
- 新增L3 BM25降级策略

---

#### 决策2: 采用ONNX动态量化替代FP32

**决策内容**:
- 使用ONNX Runtime动态量化将FP32模型转为INT8
- 运行时动态计算激活缩放因子
- 精度损失>5%时自动回退FP32

**动机**:
| 指标 | FP32 | INT8 | 收益 |
|------|------|------|------|
| 模型体积 | 200KB | 50KB | -75% |
| 推理延迟 | 25ms | 4.5ms | -82% |
| 内存占用 | 150MB | 35MB | -77% |

**量化方案对比**:

| 方案 | 延迟 | 精度 | 复杂度 | 决策 |
|------|------|------|--------|------|
| 动态量化 | <5ms | 高 | 低 | ✅ **选中** |
| 静态量化 | 0ms | 中 | 中 | 备选 |
| 量化感知训练 | N/A | 最高 | 高 | 资源不足 |

**权衡**:
- ✅ 获得：显著性能提升、自动精度保障
- ❌ 牺牲：首次量化延迟（<5ms）、约1-2%精度

**影响范围**:
- 新增AliceQuantizationEngine
- 新增1000条合成轨迹校准数据
- 新增自动回退机制

---

## 3. 备选方案

### 3.1 备选方案1: 保留SecondMe，仅优化

**描述**: 保留SecondMe，通过缓存和批量查询优化性能

**评估**:
| 维度 | 评分 | 说明 |
|------|------|------|
| 延迟 | ⭐⭐ | 仍受网络影响 |
| 成本 | ⭐ | 持续付费 |
| 隐私 | ⭐⭐ | 数据仍上云 |
| 实现难度 | ⭐⭐⭐ | 简单 |

**结论**: 否决 - 无法根本解决问题

### 3.2 备选方案2: 使用其他云服务

**描述**: 替换为Pinecone、Weaviate等向量数据库

**评估**:
| 维度 | 评分 | 说明 |
|------|------|------|
| 延迟 | ⭐⭐⭐ | 优于SecondMe |
| 成本 | ⭐⭐ | 仍需付费 |
| 隐私 | ⭐⭐ | 仍上云 |
| 迁移成本 | ⭐⭐ | 中等 |

**结论**: 延期 - 未来可考虑，当前优先本地方案

### 3.3 备选方案3: 静态量化

**描述**: 离线预量化模型，运行时直接使用INT8

**评估**:
| 维度 | 评分 | 说明 |
|------|------|------|
| 延迟 | ⭐⭐⭐⭐⭐ | 零量化延迟 |
| 精度 | ⭐⭐⭐ | 固定参数 |
| 灵活性 | ⭐⭐ | 无法适应输入分布变化 |

**结论**: 否决 - 动态量化适应性更好

---

## 4. 实施细节

### 4.1 Lazy-RAG MVP架构

```
┌─────────────────────────────────────────┐
│           API Layer (MVP)               │
│         POST /query only                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         Core Engine Layer               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ Lazy    │──│ HNSW    │──│ BM25    │ │
│  │ Loader  │  │ Index   │  │ Index   │ │
│  └────┬────┘  └────┬────┘  └────┬────┘ │
│       └────────────┼────────────┘      │
│                    │                   │
│                    ▼                   │
│            ┌─────────────┐             │
│            │ Fusion      │             │
│            │ Ranker      │             │
│            └──────┬──────┘             │
└───────────────────┼────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│           Data Layer                    │
│   vectors.bin / index.hnsw / corpus.json│
└─────────────────────────────────────────┘
```

### 4.2 ONNX量化架构

```
FP32 Model (200KB)
       │
       ▼
┌─────────────────┐
│  Calibration    │◄── 1000 synthetic trajectories
│  (Dynamic)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  INT8 Model     │
│  (50KB)         │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────┐
│ INT8  │ │ FP32  │  (fallback if similarity<0.95)
│ Infer │ │ Infer │
└───────┘ └───────┘
```

### 4.3 降级策略

```
Query Request
       │
       ▼
┌─────────────────┐
│ Check Lazy-RAG  │──Not Ready──┐
│ Status          │             │
└────────┬────────┘             │
         │ Ready                │
         ▼                      │
┌─────────────────┐             │
│ Try HNSW Search │──Timeout───┤
│ (<2s)           │            │
└────────┬────────┘            │
         │ Success             │
         ▼                     │
┌─────────────────┐            │
│ Return Results  │            │
└─────────────────┘            │
                               ▼
                    ┌─────────────────┐
                    │ L3 BM25 Fallback│
                    │ (<50ms)         │
                    └─────────────────┘
```

---

## 5. 验证结果

### 5.1 性能验证

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 冷启动 | <5s | 2.46s | ✅ |
| P95延迟 | <100ms | 92.45ms | ✅ |
| 10k内存 | <200MB | 174MB | ✅ |
| 精度损失 | <2% | 1.3% | ✅ |

### 5.2 代码质量

| 检查项 | 结果 |
|--------|------|
| SecondMe引用 | 0残留 ✅ |
| 接口定义覆盖率 | 100% ✅ |
| 类型安全 | 严格模式 ✅ |
| 文档完整性 | 六件套 ✅ |

---

## 6. 后续行动

### 6.1 短期（1-2周）

- [ ] 集成测试验证
- [ ] 性能基准自动化
- [ ] 监控告警配置

### 6.2 中期（1-3月）

- [ ] 评估Pinecone云迁移（可选）
- [ ] 支持增量索引更新
- [ ] 多节点分片方案调研

### 6.3 长期（3-6月）

- [ ] 知识图谱RAG增强
- [ ] 多模态检索支持
- [ ] 边缘设备部署优化

---

## 7. 参考

### 7.1 相关文档

- [Lazy-RAG MVP架构设计](../../design/debt/lcr-lazy-rag-mvp-arch.md)
- [ONNX量化架构设计](../../design/debt/alice-quantization-arch.md)
- [性能预算验证报告](./性能预算验证报告.md)

### 7.2 相关代码

- `lib/lcr/types/lazy-rag.ts`
- `lib/alice/quantization-config.ts`
- `scripts/start-lazy-rag.sh`
- `scripts/start-lazy-rag.ps1`

---

## 8. 变更日志

| 版本 | 日期 | 变更 | 作者 |
|------|------|------|------|
| v1.0 | 2026-02-17 | 初始ADR | Soyorin |

---

**决策状态**: ✅ **已接受并实施**

> 本ADR记录Lazy-RAG MVP的核心架构决策，所有参与者在实施相关功能前应阅读本文档。
